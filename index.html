<!DOCTYPE html>
<html>
<head>
    <title>JC Street Sweeping Rules</title>
    <!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

</head>
<body>
    
    <div id="heading">
        <div><h1>Downtown Jersey City Street Sweeping Rules</h1></div>
    </div>
    
    <div id="content-area">
        <div id="map-area">
            <div id="directions">
                <ol id="directions-content">
                    <li>Tap on a neighborhood. Curb lines will appear.</li>
                    <li>Tap on a line to see rules for that street side.</li>
                    <li>Streets without lines have no <strong>street sweeping</strong> rules.</li>
                </ol>
            </div>
            
            <div id="map"></div>



            </div>

    </div>
    <!-- <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script>
        // Create web map object
        var map = L.map('map',{
            //coordinates for grove street plaza as the center of the map
            center: [40.719648, -74.042058],
            zoom: 15 }
        );

        var streetLines = null;

        // Add tile layer for Open Street Map to map object
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);

        //MAP AND LINE FORMATTING

        //defining style separately so we can alter it later
        function style(feature) {
            return {
                weight: 6,
                opacity: .7,
                color: 'black'
            };
        };

        // function getRegulations(d) {
        //     regs = []
        //     for item in d:
        //         regs.append(item.rule.reason)
        //     return(",".join(regs))

        // };

        //changes formatting of line if pop up is present
        function highlight(e) {
            e.target.setStyle({
                weight: 10,
                opacity: 1,
                color: 'orange'
            });
        };

        //removes highlighting once you click something else and get rid of the popup
        function clearHighlight(e) {
            e.target.setStyle(style());
        };

        // function getTextForPopup(feature) {
        //   let text = `
        //     <h3>${feature.properties.location.streetName}</h3>
        //     <p>${feature.properties.location.sideOfStreet} side of street</p>
        //     <p>${feature.properties.regulations[0].rule.activity} because of ${feature.properties.regulations[0].rule.reason}
        //     on ${feature.properties.regulations[0].timeSpans[0].daysOfWeek} 
        //     between ${feature.properties.regulations[0].timeSpans[0].timesOfDay[0].from}
        //     - ${feature.properties.regulations[0].timeSpans[0].timesOfDay[0].to} </p>
        //   `;

        //   return text;
        // }


        function getTextForPopup(feature) {
          let text = `
            <h3>${feature.properties.location.streetName}</h3>
            <p>${feature.properties.location.sideOfStreet} side of street</p>
            <p>${feature.properties.regulations[0].rule.activity} because of ${feature.properties.regulations[0].rule.reason}
            on ${feature.properties.regulations[0].timeSpans[0].daysOfWeek} 
            between ${feature.properties.regulations[0].timeSpans[0].timesOfDay[0].from}
            - ${feature.properties.regulations[0].timeSpans[0].timesOfDay[0].to} </p>
          `;

          console.log(feature.properties.regulations)

          return text;
        }


        //function to create a popup for each layer
        function addPopupOnEachFeature(feature, layer) {
            layer
            .bindPopup(
                getTextForPopup(feature)
                ).on({
                popupopen: highlight,
                popupclose: clearHighlight
                //can't add mouseover highlighting with this method at the same time
            });
        };

        //ADDING AND REMOVING STREET LINES

        function addStreets() {
            $.getJSON("data/streetdata_new.geojson",function(data){
                streetLines = L.geoJson(data,{
                    style: style,
                    onEachFeature: addPopupOnEachFeature
                }).addTo(map);
            });
        }; 

        function removeStreets() {
            if(map.hasLayer(streetLines)){
                map.removeLayer(streetLines);
            }
        };

        map.on('zoomend', function() {
            if (map.getZoom() >=17 && !map.hasLayer(streetLines)){
                    addStreets();
            }
            else if (map.getZoom() <17 && map.hasLayer(streetLines)){
                    removeStreets();
                }
        });


    </script>
</body>
</html>